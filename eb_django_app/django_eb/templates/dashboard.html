{% extends 'layout.html' %}

{% block content %}
	<h2>Say an actor name (e.g. "Tom Hanks")!</h2>
	<h4 id="actor_info"></h4>

	<button id="start_button" onclick="startButton(event)">Click to Speak</button>

	<div id="results">
		<span id="final_span"></span>
		<span id="interim_span"></span>
	</div>

	<script>
		var final_transcript = '';
		var recognizing = false;
		var ignore_onend;
		var start_timestamp;
		if (!('webkitSpeechRecognition' in window)) {
			upgrade();
		} else {
			var recognition = new webkitSpeechRecognition();
			recognition.continuous = true;
			recognition.interimResults = true;
			recognition.onstart = function() {
				recognizing = true;
			};
			recognition.onerror = function(event) {
				if (event.error == 'no-speech') {
					ignore_onend = true;
				}
				if (event.error == 'audio-capture') {
					ignore_onend = true;
				}
				if (event.error == 'not-allowed') {
					ignore_onend = true;
				}
			};
			recognition.onend = function() {
				recognizing = false;
				if (window.getSelection) {
					window.getSelection().removeAllRanges();
					var range = document.createRange();
					range.selectNode(document.getElementById('final_span'));
					window.getSelection().addRange(range);
				}
			};
			recognition.onresult = function(event) {
				var interim_transcript = '';
				for (var i = event.resultIndex; i < event.results.length; ++i) {
					if (event.results[i].isFinal) {
						final_transcript += event.results[i][0].transcript;
						console.log(final_transcript);
						$.ajax({
							url : "/dashboard/",
							type : "POST",
							data : { query : final_transcript },
							success : function(json) {
								$('#actor_info').text("This actor's id is: "+json.actor_id);
							},
							error : function(xhr,errmsg,err) {

							}
						});
					} else {
						interim_transcript += event.results[i][0].transcript;
					}
				}
				final_transcript = capitalize(final_transcript);
				final_span.innerHTML = linebreak(final_transcript);
				interim_span.innerHTML = linebreak(interim_transcript);
			};
		}

		var two_line = /\n\n/g;
		var one_line = /\n/g;
		function linebreak(s) {
			return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
		}
		var first_char = /\S/;
		function capitalize(s) {
			return s.replace(first_char, function(m) { return m.toUpperCase(); });
		}

		function startButton(event) {
			if (recognizing) {
				recognition.stop();
				return;
			}
			final_transcript = '';
			recognition.lang = "en-US";
			recognition.start();
			ignore_onend = false;
			final_span.innerHTML = '';
			interim_span.innerHTML = '';
			start_timestamp = event.timeStamp;
		}
	</script>
{% endblock %}